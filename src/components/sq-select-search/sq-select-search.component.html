<div
  class="wrapper-all-inside-input wrapper-select-search {{ customClass }}"
  [ngClass]="{
    error: (externalError && externalError !== '') || (error && error !== ''),
    readonly: readonly,
    loading: loading,
  }"
>
  @if (label?.length || labelTemplate || tooltipMessage) {
    <label
      class="display-flex align-items-center"
      [ngClass]="{
        readonly: readonly,
      }"
      [for]="id"
    >
      @if (label && !labelTemplate) {
        <div [ngStyle]="{ color: labelColor }" [innerHtml]="label | universalSafe"></div>
      }
      @if (labelTemplate) {
        <span>
          <ng-container *ngTemplateOutlet="labelTemplate"></ng-container>
        </span>
      }
      @if (tooltipMessage) {
        <sq-tooltip
          class="ml-1"
          [message]="tooltipMessage"
          [placement]="tooltipPlacement"
          [color]="tooltipColor"
          [icon]="tooltipIcon"
        ></sq-tooltip>
      }
    </label>
  }
  <div
    [dataTest]="selectHandleDataTest"
    [class]="'input-fake col  border-' + borderColor"
    style="min-height: auto"
    [ngStyle]="{ 'border-color': borderColor }"
    [ngClass]="{
      'no-label': !label.length,
      'has-icon': error || externalError,
      disabled: disabled,
      readonly: readonly,
    }"
    [ngStyle]="{
      'background-color': backgroundColor,
      'border-color': borderColor,
    }"
    (clickOutside)="closeDropdown()"
    [clickOutsideEnabled]="open"
  >
    <div
      class="input-fake-content"
      [ngClass]="{
        disabled: disabled,
        readonly: readonly,
      }"
      (click)="doDropDownAction()"
    >
      @if (loading) {
        <div class="loading-wrapper">
          <sq-loader></sq-loader>
        </div>
      }
      @if (!value) {
        <span>{{ placeholder }}</span>
      }
      @if (value) {
        <div class="input-fake-content-text">
          <span class="text">
            {{ value!.label }}
          </span>
        </div>
      }
      @if (!loading) {
        <i class="icon-down fas fa-chevron-down"></i>
      }
    </div>
    @if (!disabled && !loading && renderOptionsList && !readonly) {
      <div
        class="input-window scrollbar"
        id="sq-select-search-scroll"
        [ngClass]="{
          open: !disabled && !loading && renderOptionsList && open,
        }"
      >
        <div class="input-search">
          <div class="wrapper-all-inside-input">
            <div class="p-0 wrapper-input wrapper-input-squid text-ellipsisarea">
              <input
                [dataTest]="selectInputDataTest"
                [name]="name"
                [id]="id"
                [placeholder]="placeholderSearch || ('forms.search' | translateInternal | async) || ''"
                class="col input"
                [ngModel]="searchText"
                (ngModelChange)="onTipSearchChange($event)"
              />
            </div>
            <span class="icon icon-external textarea-icon"><i class="fas fa-search"></i></span>
          </div>
        </div>
        <cdk-virtual-scroll-viewport
          itemSize="22"
          [ngStyle]="{ height: cdkVirtualScrollViewportHeight }"
          class="list scrollbar"
        >
          <ng-container *cdkVirtualFor="let opt of _options | search: searchText; i as index; trackBy: trackByOptValue">
            <ng-template *ngTemplateOutlet="option; context: { opt: opt, i: index }"></ng-template>
          </ng-container>
        </cdk-virtual-scroll-viewport>
        @if (!_options?.length) {
          @if (!selectEmptyTemplate) {
            <p class="mb-0 mt-3">
              {{ 'forms.searchSelectEmpty' | translateInternal | async }}
            </p>
          }
          @if (selectEmptyTemplate) {
            <span>
              <ng-container *ngTemplateOutlet="selectEmptyTemplate"></ng-container>
            </span>
          }
        }
      </div>
    }
  </div>
  @if (errorSpan) {
    <div
      class="box-validation box-invalid show"
      [ngClass]="{
        'visibility-hidden-force':
          ((!externalError || externalError === '') && (!error || error === '')) || disabled || readonly,
      }"
    >
      <i
        [ngClass]="{
          'visibility-hidden-force': !error && !externalError,
        }"
        class="fa-solid fa-triangle-exclamation"
      ></i>
      {{ externalError ? externalError : '' }}
      {{ error && !externalError ? error : '' }}
    </div>
  }
</div>
<ng-template #option let-opt="opt" let-i="i">
  <li
    [dataTest]="SelectOptionDataTest + '-' + (i || opt.value)"
    (click)="!opt.disabled ? emit(opt) : ''"
    [ngClass]="{ disabled: opt.disabled }"
  >
    <span class="text m-0 display-inline-block">{{ opt?.label }}</span>
  </li>
</ng-template>
